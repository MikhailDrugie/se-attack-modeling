import enum
from sqlalchemy import Column, Integer, String, ForeignKey, Text
from sqlalchemy.orm import relationship
from enums import Lang
from .base import Base, LabeledEnumMixin


class SeverityEnum(LabeledEnumMixin, enum.IntEnum):
    LOW = 1
    MEDIUM = 2
    HIGH = 3
    CRITICAL = 4
    
    @classmethod
    def labels(cls, lang = Lang.RU):
        if lang == Lang.ENG:
            return {
                cls.LOW: 'Low',
                cls.MEDIUM: 'Medium',
                cls.HIGH: 'High',
                cls.CRITICAL: 'Critical'
            }
        return {
            cls.LOW: 'Низкий',
            cls.MEDIUM: 'Средний',
            cls.HIGH: 'Высокий',
            cls.CRITICAL: 'Критический'
        }
    

class VulnerabilityTypesEnum(LabeledEnumMixin, enum.IntEnum):
    SQL_INJECT = 1   # CWE-89
    XSS = 2          # CWE-79
    CSRF = 3         # CWE-352
    BRUTE = 4        # CWE-307 (Bruteforce)
    SESSION = 5      # CWE-642 (Session fixation/hijacking)
    CONFIG = 6       # CWE-16 (Configuration)
    SAST = 7         # Общий статический анализ
    MISC = 8         # Кастом
    
    @classmethod
    def cwe_map(cls):
        return {
            VulnerabilityTypesEnum.SQL_INJECT: "CWE-89",
            VulnerabilityTypesEnum.XSS: "CWE-79",
            VulnerabilityTypesEnum.CSRF: "CWE-352",
            VulnerabilityTypesEnum.BRUTE: "CWE-307",
            VulnerabilityTypesEnum.SESSION: "CWE-642",
            VulnerabilityTypesEnum.CONFIG: "CWE-16",
            VulnerabilityTypesEnum.SAST: None, 
            VulnerabilityTypesEnum.MISC: None,
        }
    
    @property
    def cwe(self) -> str | None:
        return self.cwe_map()[self]
    
    @classmethod
    def labels(cls, lang = Lang.RU):
        if lang == Lang.ENG:
            return {
                cls.SQL_INJECT: "SQL Injection",
                cls.XSS: "XSS Attack",
                cls.CSRF: "CSRF Attack",
                cls.BRUTE: "Bruteforce",
                cls.SESSION: "Session Fixation/Hijacking",
                cls.CONFIG: "Configuration",
                cls.SAST: "Static Analysis",
                cls.MISC: "Miscellaneous"
            }
        return {
            cls.SQL_INJECT: "SQL Инъекция",
            cls.XSS: "XSS Атака",
            cls.CSRF: "CSRF Атака",
            cls.BRUTE: "Брутфорс",
            cls.SESSION: "Перехват Сессии",
            cls.CONFIG: "Конфигурация",
            cls.SAST: "Статический Анализ",
            cls.MISC: "Другое"
        }
    

class Vulnerability(Base):
    __tablename__ = "vulnerabilities"

    id = Column(Integer, primary_key=True, index=True)
    scan_id = Column(Integer, ForeignKey("scans.id"), nullable=False)
    
    name = Column(String(255), nullable=False)
    description = Column(Text)
    type = Column(Integer, nullable=False, default=VulnerabilityTypesEnum.MISC)
    severity = Column(Integer, nullable=False, default=SeverityEnum.LOW)
    url_path = Column(String(512))
    
    scan = relationship("Scan", back_populates="vulnerabilities")
    
    cwe_id = Column(String(20), ForeignKey("cwe.id"), nullable=True)
    cwe = relationship("CWE", back_populates="vulnerabilities")
    
    @property
    def type_enum(self) -> VulnerabilityTypesEnum:
        return VulnerabilityTypesEnum(self.type)
    
    @property
    def severity_enum(self) -> SeverityEnum:
        return SeverityEnum(self.severity)
